<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Todo</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-md mx-auto bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-2xl font-bold mb-4 text-gray-800">Smart Todo</h1>
            
            <form id="todoForm" class="mb-6">
                <div class="flex gap-2">
                    <input type="text" id="todoInput" placeholder="Add a new task" 
                           class="flex-1 p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <input type="datetime-local" id="todoDate" 
                           class="p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <button type="submit" 
                            class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        Add
                    </button>
                </div>
            </form>

            <ul id="todoList" class="space-y-2"></ul>
        </div>
    </div>

    <script>
        let todos = JSON.parse(localStorage.getItem('todos')) || [];

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(registration => requestNotificationPermission());
        }

        async function requestNotificationPermission() {
            const permission = await Notification.requestPermission();
            if (permission !== 'granted') {
                alert('Please allow notifications to get reminders');
            }
        }

        function createNotification(todo) {
            if (Notification.permission === 'granted') {
                navigator.serviceWorker.ready.then(registration => {
                    registration.showNotification('Todo Reminder', {
                        body: todo.text,
                        icon: '/icon.png',
                        vibrate: [200, 100, 200]
                    });
                });
            }
        }

        function addTodo(text, dueDate) {
            const todo = {
                id: Date.now(),
                text,
                dueDate,
                completed: false
            };
            
            todos.push(todo);
            localStorage.setItem('todos', JSON.stringify(todos));
            renderTodos();

            if (dueDate) {
                const notificationTime = new Date(dueDate).getTime();
                const now = new Date().getTime();
                
                if (notificationTime > now) {
                    setTimeout(() => createNotification(todo), notificationTime - now);
                }
            }
        }

        function toggleTodo(id) {
            todos = todos.map(todo => 
                todo.id === id ? {...todo, completed: !todo.completed} : todo
            );
            localStorage.setItem('todos', JSON.stringify(todos));
            renderTodos();
        }

        function deleteTodo(id) {
            todos = todos.filter(todo => todo.id !== id);
            localStorage.setItem('todos', JSON.stringify(todos));
            renderTodos();
        }

        function renderTodos() {
            const todoList = document.getElementById('todoList');
            todoList.innerHTML = '';
            
            todos.forEach(todo => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between p-3 bg-gray-50 rounded';
                
                const textSpan = document.createElement('span');
                textSpan.className = todo.completed ? 'line-through text-gray-500' : '';
                textSpan.textContent = todo.text;
                
                const dateSpan = document.createElement('span');
                dateSpan.className = 'text-sm text-gray-500';
                dateSpan.textContent = todo.dueDate ? new Date(todo.dueDate).toLocaleString() : '';
                
                const actions = document.createElement('div');
                actions.className = 'flex gap-2';
                
                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'text-blue-500 hover:text-blue-700';
                toggleBtn.innerHTML = todo.completed ? '↩️' : '✓';
                toggleBtn.onclick = () => toggleTodo(todo.id);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-red-500 hover:text-red-700';
                deleteBtn.innerHTML = '×';
                deleteBtn.onclick = () => deleteTodo(todo.id);
                
                actions.appendChild(toggleBtn);
                actions.appendChild(deleteBtn);
                
                li.appendChild(textSpan);
                li.appendChild(dateSpan);
                li.appendChild(actions);
                
                todoList.appendChild(li);
            });
        }

        document.getElementById('todoForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('todoInput');
            const dateInput = document.getElementById('todoDate');
            
            if (input.value.trim()) {
                addTodo(input.value.trim(), dateInput.value);
                input.value = '';
                dateInput.value = '';
            }
        });

        renderTodos();
    </script>
</body>
</html>